<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Profile Page</title>
    
    <!-- Firebase FIRST -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Then config -->
    <script src="config.js"></script>
    
    <!-- Then Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#4CAF50",
                        "background-light": "#F7F7F7",
                        "background-dark": "#102210",
                        "neutral-text-light": "#333333",
                        "neutral-text-dark": "#E0E0E0",
                        "neutral-border-light": "#E0E0E0",
                        "neutral-border-dark": "#334133",
                        "neutral-bg-light": "#FFFFFF",
                        "neutral-bg-dark": "#1A2E1A",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        /* Mobile Menu */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .menu-overlay {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .dark .modal-content {
            background-color: #1A2E1A;
            color: #E0E0E0;
        }

        /* Toast Styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background-color: #10B981;
        }

        .toast.error {
            background-color: #EF4444;
        }

        .toast.warning {
            background-color: #F59E0B;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #2a3a2a 25%, #334133 50%, #2a3a2a 75%);
            background-size: 200% 100%;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Email verification badge */
        .verified-badge {
            background-color: #10B981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .unverified-badge {
            background-color: #F59E0B;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-neutral-text-light dark:text-neutral-text-dark">
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white dark:bg-background-dark z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-neutral-text-light dark:text-neutral-text-dark">Loading your profile...</p>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="menu-overlay fixed inset-0 bg-black/50 z-40 lg:hidden" id="menuOverlay"></div>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu fixed left-0 top-0 h-full w-80 bg-neutral-bg-light dark:bg-neutral-bg-dark shadow-xl z-50 p-6 lg:hidden" id="mobileMenu">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold">Menu</h2>
            <button class="text-2xl" id="closeMenuBtn">×</button>
        </div>
        <nav class="space-y-4 flex-1">
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary" href="#profile">
                <span class="material-symbols-outlined fill">person</span>
                <p class="text-sm font-medium leading-normal">Profile</p>
            </a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="#orders">
                <span class="material-symbols-outlined">receipt_long</span>
                <p class="text-sm font-medium leading-normal">Order History</p>
            </a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="#addresses">
                <span class="material-symbols-outlined">home_pin</span>
                <p class="text-sm font-medium leading-normal">Saved Addresses</p>
            </a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="#payments">
                <span class="material-symbols-outlined">credit_card</span>
                <p class="text-sm font-medium leading-normal">Payment Methods</p>
            </a>
        </nav>
        <div class="flex flex-col gap-1 mt-8">
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="cart.html">
                <span class="material-symbols-outlined">shopping_cart</span>
                <p class="text-sm font-medium leading-normal">Back to Cart</p>
            </a>
            <button class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10 text-red-500" id="mobileLogoutBtn">
                <span class="material-symbols-outlined">logout</span>
                <p class="text-sm font-medium leading-normal">Logout</p>
            </button>
        </div>
    </div>

    <div class="relative flex min-h-screen w-full flex-col">
        <!-- Mobile Header -->
        <header class="lg:hidden flex items-center justify-between p-4 border-b border-neutral-border-light dark:border-neutral-border-dark bg-neutral-bg-light dark:bg-neutral-bg-dark">
            <button class="text-2xl" id="menuBtn">☰</button>
            <h1 class="text-xl font-bold">My Account</h1>
            <div class="w-6"></div> <!-- Spacer for balance -->
        </header>

        <div class="flex h-full flex-1">
            <!-- Desktop Sidebar -->
            <aside class="hidden lg:flex w-64 flex-col bg-neutral-bg-light dark:bg-neutral-bg-dark p-4 border-r border-neutral-border-light dark:border-neutral-border-dark">
                <div class="flex flex-col grow">
                    <div class="flex gap-3 items-center mb-8 px-2">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12 skeleton" id="profileImage" data-alt="Profile picture"></div>
                        <div class="flex flex-col">
                            <h1 class="text-neutral-text-light dark:text-neutral-text-dark text-base font-bold leading-normal skeleton h-4 w-24 mb-2" id="sidebarUserName"></h1>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal skeleton h-3 w-32" id="sidebarUserEmail"></p>
                            <div class="mt-1" id="emailVerificationBadge"></div>
                        </div>
                    </div>
                    <nav class="flex flex-col gap-2">
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary" href="#profile">
                            <span class="material-symbols-outlined fill">person</span>
                            <p class="text-sm font-medium leading-normal">Profile</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="#orders">
                            <span class="material-symbols-outlined">receipt_long</span>
                            <p class="text-sm font-medium leading-normal">Order History</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="#addresses">
                            <span class="material-symbols-outlined">home_pin</span>
                            <p class="text-sm font-medium leading-normal">Saved Addresses</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="#payments">
                            <span class="material-symbols-outlined">credit_card</span>
                            <p class="text-sm font-medium leading-normal">Payment Methods</p>
                        </a>
                    </nav>
                </div>
                <div class="flex flex-col gap-1">
                    <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10" href="cart.html">
                        <span class="material-symbols-outlined">shopping_cart</span>
                        <p class="text-sm font-medium leading-normal">Back to Cart</p>
                    </a>
                    <button class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10 text-red-500" id="logoutBtn">
                        <span class="material-symbols-outlined">logout</span>
                        <p class="text-sm font-medium leading-normal">Logout</p>
                    </button>
                </div>
            </aside>

            <main class="flex-1 p-4 lg:p-8">
                <div class="max-w-4xl mx-auto">
                    <header class="mb-8 hidden lg:block">
                        <h1 class="text-neutral-text-light dark:text-neutral-text-dark text-4xl font-black leading-tight tracking-[-0.03em]">My Account</h1>
                    </header>
                    
                    <div class="flex flex-col gap-8">
                        <!-- Profile Information Section -->
                        <section id="profile" class="bg-neutral-bg-light dark:bg-neutral-bg-dark border border-neutral-border-light dark:border-neutral-border-dark rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-neutral-text-light dark:text-neutral-text-dark">Personal Information</h2>
                                <button class="text-sm font-medium text-primary hover:underline" id="editProfileBtn">Edit</button>
                            </div>
                            
                            <!-- Email Verification Status -->
                            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg" id="emailVerificationNotice">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-blue-500">info</span>
                                    <div>
                                        <p class="text-sm font-medium text-blue-800 dark:text-blue-200" id="verificationText"></p>
                                        <button class="text-sm text-blue-600 dark:text-blue-400 hover:underline mt-1" id="resendVerificationBtn">Resend verification email</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Image Upload -->
                            <div class="flex flex-col items-center mb-6">
                                <div class="relative">
                                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-24 border-4 border-white dark:border-neutral-bg-dark shadow-lg skeleton" id="profileImageDisplay"></div>
                                    <button class="absolute bottom-0 right-0 bg-primary text-white rounded-full p-2 shadow-lg hover:bg-primary/90" id="changePhotoBtn">
                                        <span class="material-symbols-outlined" style="font-size: 16px;">photo_camera</span>
                                    </button>
                                    <input type="file" id="profileImageInput" accept="image/*" class="hidden"/>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Click camera icon to change photo</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <label class="flex flex-col">
                                    <p class="text-sm font-medium leading-normal pb-2 text-gray-600 dark:text-gray-300">Full Name</p>
                                    <input class="form-input w-full rounded-lg text-neutral-text-light dark:text-neutral-text-dark border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-12 px-4 text-base font-normal skeleton" id="fullNameInput" readonly value=""/>
                                </label>
                                <label class="flex flex-col">
                                    <p class="text-sm font-medium leading-normal pb-2 text-gray-600 dark:text-gray-300">Email Address</p>
                                    <div class="flex items-center gap-2">
                                        <input class="form-input w-full rounded-lg text-neutral-text-light dark:text-neutral-text-dark border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-12 px-4 text-base font-normal skeleton" id="emailInput" readonly value=""/>
                                        <span class="verified-badge hidden" id="emailVerifiedBadge">Verified</span>
                                        <span class="unverified-badge hidden" id="emailUnverifiedBadge">Unverified</span>
                                    </div>
                                </label>
                                <label class="flex flex-col">
                                    <p class="text-sm font-medium leading-normal pb-2 text-gray-600 dark:text-gray-300">Phone Number</p>
                                    <input class="form-input w-full rounded-lg text-neutral-text-light dark:text-neutral-text-dark border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-12 px-4 text-base font-normal skeleton" id="phoneInput" readonly value=""/>
                                </label>
                                <label class="flex flex-col">
                                    <p class="text-sm font-medium leading-normal pb-2 text-gray-600 dark:text-gray-300">Member Since</p>
                                    <input class="form-input w-full rounded-lg text-neutral-text-light dark:text-neutral-text-dark border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-12 px-4 text-base font-normal skeleton" id="memberSinceInput" readonly value=""/>
                                </label>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-neutral-border-light dark:border-neutral-border-dark">
                                <h3 class="text-lg font-bold text-neutral-text-light dark:text-neutral-text-dark mb-4">Change Password</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <label class="flex flex-col">
                                        <p class="text-sm font-medium leading-normal pb-2 text-gray-600 dark:text-gray-300">Current Password</p>
                                        <input class="form-input w-full rounded-lg text-neutral-text-light dark:text-neutral-text-dark border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-12 px-4 text-base font-normal" id="currentPassword" placeholder="Enter current password" type="password"/>
                                    </label>
                                    <label class="flex flex-col">
                                        <p class="text-sm font-medium leading-normal pb-2 text-gray-600 dark:text-gray-300">New Password</p>
                                        <input class="form-input w-full rounded-lg text-neutral-text-light dark:text-neutral-text-dark border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-12 px-4 text-base font-normal" id="newPassword" placeholder="Enter new password" type="password"/>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6 gap-4 hidden" id="profileActions">
                                <button class="px-6 py-2.5 border border-neutral-border-light dark:border-neutral-border-dark rounded-lg font-semibold text-sm" id="cancelEditBtn">Cancel</button>
                                <button class="px-6 py-2.5 bg-primary text-white rounded-lg font-semibold text-sm" id="saveProfileBtn">Save Changes</button>
                            </div>
                        </section>

                        <!-- Order History Section -->
                        <section id="orders" class="bg-neutral-bg-light dark:bg-neutral-bg-dark border border-neutral-border-light dark:border-neutral-border-dark rounded-xl p-6">
                            <h2 class="text-xl font-bold text-neutral-text-light dark:text-neutral-text-dark mb-6">Order History</h2>
                            <div class="space-y-4" id="orderList">
                                <div class="p-4 rounded-lg border border-neutral-border-light dark:border-neutral-border-dark">
                                    <div class="skeleton h-4 w-32 mb-2"></div>
                                    <div class="skeleton h-3 w-24 mb-2"></div>
                                    <div class="skeleton h-3 w-16"></div>
                                </div>
                            </div>
                        </section>

                        <!-- Saved Addresses Section -->
                        <section id="addresses" class="bg-neutral-bg-light dark:bg-neutral-bg-dark border border-neutral-border-light dark:border-neutral-border-dark rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-neutral-text-light dark:text-neutral-text-dark">Saved Addresses</h2>
                                <button class="flex items-center gap-2 px-4 py-2.5 bg-primary text-white rounded-lg font-semibold text-sm" id="addAddressBtn">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">add</span> Add New Address
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="addressList">
                                <div class="p-4 rounded-lg border border-neutral-border-light dark:border-neutral-border-dark">
                                    <div class="skeleton h-4 w-24 mb-2"></div>
                                    <div class="skeleton h-3 w-32"></div>
                                </div>
                            </div>
                        </section>

                        <!-- Payment Methods Section -->
                        <section id="payments" class="bg-neutral-bg-light dark:bg-neutral-bg-dark border border-neutral-border-light dark:border-neutral-border-dark rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-neutral-text-light dark:text-neutral-text-dark">Payment Methods</h2>
                                <button class="flex items-center gap-2 px-4 py-2.5 bg-primary text-white rounded-lg font-semibold text-sm" id="addPaymentBtn">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">add</span> Add New Card
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="paymentList">
                                <div class="p-4 rounded-lg border border-neutral-border-light dark:border-neutral-border-dark">
                                    <div class="skeleton h-4 w-32 mb-2"></div>
                                    <div class="skeleton h-3 w-24"></div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Address Modal -->
    <div id="addressModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold" id="addressModalTitle">Add New Address</h3>
                    <button class="text-2xl" id="closeAddressModal">&times;</button>
                </div>
                <form id="addressForm" class="space-y-4">
                    <input type="hidden" id="addressId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">Label</span>
                            <input type="text" id="addressLabel" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" placeholder="Home, Work, etc." required>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">Full Name</span>
                            <input type="text" id="addressFullName" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" required>
                        </label>
                    </div>
                    <label class="flex flex-col">
                        <span class="text-sm font-medium mb-1">Street Address</span>
                        <input type="text" id="addressStreet" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" required>
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">City</span>
                            <input type="text" id="addressCity" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" required>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">State</span>
                            <input type="text" id="addressState" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" required>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">ZIP Code</span>
                            <input type="text" id="addressZip" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" required>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">Country</span>
                            <input type="text" id="addressCountry" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" value="United States" required>
                        </label>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" class="px-4 py-2 border border-neutral-border-light dark:border-neutral-border-dark rounded-lg" id="cancelAddressModal">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold" id="paymentModalTitle">Add Payment Method</h3>
                    <button class="text-2xl" id="closePaymentModal">&times;</button>
                </div>
                <form id="paymentForm" class="space-y-4">
                    <input type="hidden" id="paymentId">
                    <label class="flex flex-col">
                        <span class="text-sm font-medium mb-1">Card Number</span>
                        <input type="text" id="cardNumber" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" placeholder="1234 5678 9012 3456" required>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">Expiry Date</span>
                            <input type="text" id="cardExpiry" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" placeholder="MM/YY" required>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-sm font-medium mb-1">CVV</span>
                            <input type="text" id="cardCvv" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" placeholder="123" required>
                        </label>
                    </div>
                    <label class="flex flex-col">
                        <span class="text-sm font-medium mb-1">Cardholder Name</span>
                        <input type="text" id="cardName" class="form-input rounded-lg border border-neutral-border-light dark:border-neutral-border-dark bg-transparent dark:bg-background-dark h-10 px-3" required>
                    </label>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="setAsDefault" class="rounded border-neutral-border-light dark:border-neutral-border-dark">
                        <label for="setAsDefault" class="text-sm">Set as default payment method</label>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" class="px-4 py-2 border border-neutral-border-light dark:border-neutral-border-dark rounded-lg" id="cancelPaymentModal">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Save Card</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Debug: Check if Firebase is loaded
        console.log('Firebase loaded:', typeof firebase !== 'undefined');
        console.log('Firebase auth:', typeof auth !== 'undefined');
        console.log('Firebase db:', typeof db !== 'undefined');

        // Initialize Firebase Storage
        const storage = firebase.storage();

        // User data management (NO CACHING)
        let currentUser = null;
        let userData = {};
        let addresses = [];
        let paymentMethods = [];
        let orders = [];

        // DOM Elements
        const menuBtn = document.getElementById('menuBtn');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const menuOverlay = document.getElementById('menuOverlay');
        const mobileMenu = document.getElementById('mobileMenu');
        const logoutBtn = document.getElementById('logoutBtn');
        const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const profileActions = document.getElementById('profileActions');
        const changePhotoBtn = document.getElementById('changePhotoBtn');
        const profileImageInput = document.getElementById('profileImageInput');
        const profileImageDisplay = document.getElementById('profileImageDisplay');
        const fullNameInput = document.getElementById('fullNameInput');
        const emailInput = document.getElementById('emailInput');
        const phoneInput = document.getElementById('phoneInput');
        const memberSinceInput = document.getElementById('memberSinceInput');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const emailVerificationNotice = document.getElementById('emailVerificationNotice');
        const verificationText = document.getElementById('verificationText');
        const resendVerificationBtn = document.getElementById('resendVerificationBtn');
        const emailVerifiedBadge = document.getElementById('emailVerifiedBadge');
        const emailUnverifiedBadge = document.getElementById('emailUnverifiedBadge');
        const emailVerificationBadge = document.getElementById('emailVerificationBadge');

        // Address Management
        const addAddressBtn = document.getElementById('addAddressBtn');
        const addressList = document.getElementById('addressList');
        const addressModal = document.getElementById('addressModal');
        const closeAddressModal = document.getElementById('closeAddressModal');
        const cancelAddressModal = document.getElementById('cancelAddressModal');
        const addressForm = document.getElementById('addressForm');
        const addressModalTitle = document.getElementById('addressModalTitle');

        // Payment Management
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const paymentList = document.getElementById('paymentList');
        const paymentModal = document.getElementById('paymentModal');
        const closePaymentModal = document.getElementById('closePaymentModal');
        const cancelPaymentModal = document.getElementById('cancelPaymentModal');
        const paymentForm = document.getElementById('paymentForm');
        const paymentModalTitle = document.getElementById('paymentModalTitle');

        // Order Management
        const orderList = document.getElementById('orderList');

        // Toast functionality
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Remove skeleton loading
        function removeSkeleton(element) {
            if (element) {
                element.classList.remove('skeleton');
                if (element.tagName === 'INPUT') {
                    element.value = element.value || '';
                }
            }
        }

        // Mobile Menu Functionality
        function openMenu() {
            mobileMenu.classList.add('open');
            menuOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            mobileMenu.classList.remove('open');
            menuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        menuBtn.addEventListener('click', openMenu);
        closeMenuBtn.addEventListener('click', closeMenu);
        menuOverlay.addEventListener('click', closeMenu);

        // Modal Functions
        function openModal(modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Check authentication state (NO CACHING)
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.uid);
                
                // Hide loading overlay
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
                
                // Load user data directly from Firebase
                await loadUserData();
                await loadAddresses();
                await loadPaymentMethods();
                await loadOrders();
                updateUI();
            } else {
                console.log('No user, redirecting to login');
                window.location.href = 'authpages.html';
            }
        });

        // Load user data from Firestore (NO CACHING)
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = { uid: currentUser.uid, ...userDoc.data() };
                    console.log('User data loaded:', userData);
                } else {
                    // Create user document if it doesn't exist
                    userData = {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName || 'User',
                        email: currentUser.email,
                        phone: '',
                        photoURL: currentUser.photoURL || 'https://lh3.googleusercontent.com/aida-public/AB6AXuDNJGzlcek8-Txtae43H8yeBsUQYc5iPVoI4apGiXGgOnoICkKFcLaFPXxg4A3F2Ro6HlAoqk9GnRHoakEsrYYRudBSYqvoZEiB1H5re3o2dF9vfc4uZck4knk3JlK7pKuvFA31PcuVgTQMhEQYl93eq7AJw_zpEflsX1Cy2JW6xKmNuuFXNJVOS4KjixExio7R5FKEgXb2vN5OPtw_cdmIUPhrsFPM7yameXZZf_S-ppVE7I2nogkIQsDaAs2EL8XfSxHhNEKMIpj2',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        emailVerified: currentUser.emailVerified
                    };
                    await db.collection('users').doc(currentUser.uid).set(userData);
                    console.log('New user document created');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading profile data', 'error');
            }
        }

        // Load addresses from Firestore (NO CACHING)
        async function loadAddresses() {
            try {
                const addressesSnapshot = await db.collection('users').doc(currentUser.uid).collection('addresses').get();
                addresses = [];
                addressesSnapshot.forEach(doc => {
                    addresses.push({ id: doc.id, ...doc.data() });
                });
                console.log('Addresses loaded:', addresses.length);
            } catch (error) {
                console.error('Error loading addresses:', error);
                showToast('Error loading addresses', 'error');
            }
        }

        // Load payment methods from Firestore (NO CACHING)
        async function loadPaymentMethods() {
            try {
                const paymentsSnapshot = await db.collection('users').doc(currentUser.uid).collection('payments').get();
                paymentMethods = [];
                paymentsSnapshot.forEach(doc => {
                    paymentMethods.push({ id: doc.id, ...doc.data() });
                });
                console.log('Payment methods loaded:', paymentMethods.length);
            } catch (error) {
                console.error('Error loading payment methods:', error);
                showToast('Error loading payment methods', 'error');
            }
        }

        // Load orders from Firestore (NO CACHING)
        async function loadOrders() {
            try {
                const ordersSnapshot = await db.collection('users').doc(currentUser.uid).collection('orders').orderBy('createdAt', 'desc').limit(10).get();
                orders = [];
                ordersSnapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                console.log('Orders loaded:', orders.length);
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Error loading orders', 'error');
            }
        }

        // Update UI with user data
        function updateUI() {
            console.log('Updating UI with user data');
            
            // Remove skeleton loading from elements
            removeSkeleton(fullNameInput);
            removeSkeleton(emailInput);
            removeSkeleton(phoneInput);
            removeSkeleton(memberSinceInput);
            removeSkeleton(document.getElementById('sidebarUserName'));
            removeSkeleton(document.getElementById('sidebarUserEmail'));
            removeSkeleton(profileImageDisplay);
            removeSkeleton(document.getElementById('profileImage'));

            // Update profile information
            fullNameInput.value = userData.displayName || currentUser.displayName || 'User';
            emailInput.value = userData.email || currentUser.email || '';
            phoneInput.value = userData.phone || '';
            
            // Format member since date
            if (userData.createdAt) {
                const memberSince = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
                memberSinceInput.value = memberSince.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            } else {
                memberSinceInput.value = 'Recently joined';
            }
            
            // Update sidebar
            document.getElementById('sidebarUserName').textContent = userData.displayName || currentUser.displayName || 'User';
            document.getElementById('sidebarUserEmail').textContent = userData.email || currentUser.email || '';
            
            // Update profile image
            const photoURL = userData.photoURL || currentUser.photoURL;
            if (photoURL) {
                profileImageDisplay.style.backgroundImage = `url('${photoURL}')`;
                document.getElementById('profileImage').style.backgroundImage = `url('${photoURL}')`;
            }
            
            // Update email verification status
            updateEmailVerificationStatus();
            
            // Render addresses
            renderAddresses();
            
            // Render payment methods
            renderPaymentMethods();
            
            // Render orders
            renderOrders();
            
            console.log('UI update complete');
        }

        // Update email verification status
        function updateEmailVerificationStatus() {
            const isVerified = currentUser.emailVerified;
            
            if (isVerified) {
                emailVerificationNotice.style.display = 'none';
                emailVerifiedBadge.classList.remove('hidden');
                emailUnverifiedBadge.classList.add('hidden');
                if (emailVerificationBadge) {
                    emailVerificationBadge.innerHTML = '<span class="verified-badge">Verified</span>';
                }
            } else {
                emailVerificationNotice.style.display = 'block';
                emailVerifiedBadge.classList.add('hidden');
                emailUnverifiedBadge.classList.remove('hidden');
                verificationText.textContent = 'Please verify your email address to access all features.';
                if (emailVerificationBadge) {
                    emailVerificationBadge.innerHTML = '<span class="unverified-badge">Unverified</span>';
                }
            }
        }

        // Render addresses
        function renderAddresses() {
            addressList.innerHTML = '';
            
            if (addresses.length === 0) {
                addressList.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">home_pin</span>
                        <p>No addresses saved yet</p>
                    </div>
                `;
                return;
            }
            
            addresses.forEach(address => {
                const addressElement = document.createElement('div');
                addressElement.className = 'p-4 rounded-lg border border-neutral-border-light dark:border-neutral-border-dark flex flex-col justify-between';
                addressElement.innerHTML = `
                    <div>
                        <p class="font-bold text-neutral-text-light dark:text-neutral-text-dark mb-1">${address.label}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${address.street}, ${address.city}, ${address.state} ${address.zip}</p>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button class="text-sm font-medium text-primary hover:underline edit-address" data-id="${address.id}">Edit</button>
                        <button class="text-sm font-medium text-red-500 hover:underline delete-address" data-id="${address.id}">Delete</button>
                    </div>
                `;
                addressList.appendChild(addressElement);
            });
            
            // Add event listeners for address actions
            document.querySelectorAll('.edit-address').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const addressId = e.target.dataset.id;
                    editAddress(addressId);
                });
            });
            
            document.querySelectorAll('.delete-address').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const addressId = e.target.dataset.id;
                    deleteAddress(addressId);
                });
            });
        }

        // Render payment methods
        function renderPaymentMethods() {
            paymentList.innerHTML = '';
            
            if (paymentMethods.length === 0) {
                paymentList.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">credit_card</span>
                        <p>No payment methods saved yet</p>
                    </div>
                `;
                return;
            }
            
            paymentMethods.forEach(payment => {
                const isDefault = payment.isDefault || false;
                const paymentElement = document.createElement('div');
                paymentElement.className = `p-4 rounded-lg border ${isDefault ? 'border-primary dark:border-primary' : 'border-neutral-border-light dark:border-neutral-border-dark'} flex flex-col justify-between relative`;
                paymentElement.innerHTML = `
                    ${isDefault ? '<div class="absolute top-3 right-3 px-2 py-0.5 text-xs font-medium rounded-full bg-primary/10 text-primary">Default</div>' : ''}
                    <div class="flex items-center gap-4 mb-4">
                        <img alt="${payment.cardType} logo" class="h-8" src="${getCardLogo(payment.cardType)}"/>
                        <div>
                            <p class="font-bold text-neutral-text-light dark:text-neutral-text-dark">${payment.cardType} **** ${payment.last4}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Expires ${payment.expiry}</p>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-auto">
                        ${!isDefault ? `<button class="text-sm font-medium text-primary hover:underline set-default-payment" data-id="${payment.id}">Set as Default</button>` : ''}
                        <button class="text-sm font-medium text-primary hover:underline edit-payment" data-id="${payment.id}">Edit</button>
                        <button class="text-sm font-medium text-red-500 hover:underline delete-payment" data-id="${payment.id}">Delete</button>
                    </div>
                `;
                paymentList.appendChild(paymentElement);
            });
            
            // Add event listeners for payment actions
            document.querySelectorAll('.edit-payment').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const paymentId = e.target.dataset.id;
                    editPayment(paymentId);
                });
            });
            
            document.querySelectorAll('.delete-payment').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const paymentId = e.target.dataset.id;
                    deletePayment(paymentId);
                });
            });
            
            document.querySelectorAll('.set-default-payment').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const paymentId = e.target.dataset.id;
                    setDefaultPayment(paymentId);
                });
            });
        }

        // Render orders
        function renderOrders() {
            orderList.innerHTML = '';
            if (orders.length === 0) {
                orderList.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">receipt_long</span>
                        <p>No orders found</p>
                    </div>
                `;
                return;
            }
            
            orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'p-4 rounded-lg border border-neutral-border-light dark:border-neutral-border-dark flex flex-wrap justify-between items-center gap-4';
                orderElement.innerHTML = `
                    <div class="flex flex-col">
                        <p class="font-bold text-neutral-text-light dark:text-neutral-text-dark">Order #${order.id.slice(-6)}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(order.createdAt?.toDate()).toLocaleDateString()}</p>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Total: $${order.total?.toFixed(2) || '0.00'}</div>
                    <div class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">${order.status || 'Delivered'}</div>
                    <button class="text-sm font-medium text-primary hover:underline view-order" data-id="${order.id}">View Details</button>
                `;
                orderList.appendChild(orderElement);
            });
        }

        // Get card logo based on card type
        function getCardLogo(cardType) {
            const logos = {
                'Visa': 'https://lh3.googleusercontent.com/aida-public/AB6AXuC5nP4B2z1axJU5cJPt7sr1bosUEcpEygs1Dn-GBc1ZrcfqPmDGlmGxskN8_0-pqyW0RRKTk1rItZeptObjdnqb9RL0U-Vk0KAh4SO-L2sKw0sB8hvlQu3cmTgPLAxdJIknFLCSdljxctnk_vJrG_S1qIPhd7BfxAvKKQU5XFaEzCMEHSI9webzD5h9KRbgpKYst9W9QsKRPxSOX4z-LpxNccsnxQGDmcJuHXWXvIzb1mIGn1Q4C7ftxTB0sx3cnG0rmSnOShDtgBM8',
                'Mastercard': 'https://lh3.googleusercontent.com/aida-public/AB6AXuCGQ95Rd0MtoZn3L7lYF3XNArbTU2aDvd7UunR81vWH_vXTMH4n8R70VnWIVqhwEXa9AHUm_1dvt9WTbJKooZDCM4EPPFHay4SzA75hueVhjOtU5xouBTghbvIacw4M17lrjl1By8VIBsgyZ3T3b55vu52cwJBDulRlVz7yDASEYBcr2lRhxB9xVq7WvW5qyPLd1YObh699U5OVzY7gDKEGSArP38Gi91wYL-abafz-V7-kX3XEo3Jl9pOT4F2Ym3BhGg8HK8znSkNy',
                'Amex': 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/American_Express_logo_%282018%29.svg/800px-American_Express_logo_%282018%29.svg.png',
                'Discover': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Discover_Card_logo.svg/800px-Discover_Card_logo.svg.png'
            };
            return logos[cardType] || logos['Visa'];
        }

        // Resend email verification
        resendVerificationBtn.addEventListener('click', async () => {
            try {
                await currentUser.sendEmailVerification({
                    url: window.location.origin,
                    handleCodeInApp: true
                });
                showToast('Verification email sent! Please check your inbox.', 'success');
            } catch (error) {
                console.error('Error sending verification email:', error);
                showToast('Error sending verification email: ' + error.message, 'error');
            }
        });

        // Profile Edit Functionality
        editProfileBtn.addEventListener('click', () => {
            fullNameInput.readOnly = false;
            phoneInput.readOnly = false;
            profileActions.classList.remove('hidden');
            editProfileBtn.classList.add('hidden');
        });

        cancelEditBtn.addEventListener('click', () => {
            fullNameInput.readOnly = true;
            phoneInput.readOnly = true;
            fullNameInput.value = userData.displayName || currentUser.displayName || 'User';
            phoneInput.value = userData.phone || '';
            profileActions.classList.add('hidden');
            editProfileBtn.classList.remove('hidden');
        });

        saveProfileBtn.addEventListener('click', async () => {
            try {
                const updates = {
                    displayName: fullNameInput.value,
                    phone: phoneInput.value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).update(updates);
                userData = { ...userData, ...updates };
                
                // Update password if provided
                if (currentPassword.value && newPassword.value) {
                    await currentUser.updatePassword(newPassword.value);
                    currentPassword.value = '';
                    newPassword.value = '';
                    showToast('Password updated successfully!');
                }
                
                fullNameInput.readOnly = true;
                phoneInput.readOnly = true;
                profileActions.classList.add('hidden');
                editProfileBtn.classList.remove('hidden');
                
                updateUI();
                showToast('Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Error updating profile: ' + error.message, 'error');
            }
        });

        // Profile Image Upload
        changePhotoBtn.addEventListener('click', () => {
            profileImageInput.click();
        });

        profileImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    // Upload to Firebase Storage
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child(`profile-images/${currentUser.uid}/${file.name}`);
                    await fileRef.put(file);
                    const photoURL = await fileRef.getDownloadURL();
                    
                    // Update user profile
                    await currentUser.updateProfile({
                        photoURL: photoURL
                    });
                    
                    await db.collection('users').doc(currentUser.uid).update({
                        photoURL: photoURL,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    userData.photoURL = photoURL;
                    
                    updateUI();
                    showToast('Profile photo updated successfully!');
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    showToast('Error uploading photo: ' + error.message, 'error');
                }
            }
        });

        // Address Management
        addAddressBtn.addEventListener('click', () => {
            addressModalTitle.textContent = 'Add New Address';
            addressForm.reset();
            document.getElementById('addressId').value = '';
            document.getElementById('addressFullName').value = userData.displayName || currentUser.displayName || '';
            openModal(addressModal);
        });

        closeAddressModal.addEventListener('click', () => closeModal(addressModal));
        cancelAddressModal.addEventListener('click', () => closeModal(addressModal));

        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const addressId = document.getElementById('addressId').value;
            const addressData = {
                label: document.getElementById('addressLabel').value,
                fullName: document.getElementById('addressFullName').value,
                street: document.getElementById('addressStreet').value,
                city: document.getElementById('addressCity').value,
                state: document.getElementById('addressState').value,
                zip: document.getElementById('addressZip').value,
                country: document.getElementById('addressCountry').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (addressId) {
                    // Update existing address
                    await db.collection('users').doc(currentUser.uid).collection('addresses').doc(addressId).update(addressData);
                    showToast('Address updated successfully!');
                } else {
                    // Add new address
                    addressData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('users').doc(currentUser.uid).collection('addresses').add(addressData);
                    showToast('Address added successfully!');
                }
                
                await loadAddresses();
                renderAddresses();
                closeModal(addressModal);
            } catch (error) {
                console.error('Error saving address:', error);
                showToast('Error saving address: ' + error.message, 'error');
            }
        });

        function editAddress(addressId) {
            const address = addresses.find(addr => addr.id === addressId);
            if (address) {
                addressModalTitle.textContent = 'Edit Address';
                document.getElementById('addressId').value = address.id;
                document.getElementById('addressLabel').value = address.label;
                document.getElementById('addressFullName').value = address.fullName;
                document.getElementById('addressStreet').value = address.street;
                document.getElementById('addressCity').value = address.city;
                document.getElementById('addressState').value = address.state;
                document.getElementById('addressZip').value = address.zip;
                document.getElementById('addressCountry').value = address.country;
                openModal(addressModal);
            }
        }

        async function deleteAddress(addressId) {
            if (confirm('Are you sure you want to delete this address?')) {
                try {
                    await db.collection('users').doc(currentUser.uid).collection('addresses').doc(addressId).delete();
                    await loadAddresses();
                    renderAddresses();
                    showToast('Address deleted successfully!');
                } catch (error) {
                    console.error('Error deleting address:', error);
                    showToast('Error deleting address: ' + error.message, 'error');
                }
            }
        }

        // Payment Management
        addPaymentBtn.addEventListener('click', () => {
            paymentModalTitle.textContent = 'Add Payment Method';
            paymentForm.reset();
            document.getElementById('paymentId').value = '';
            document.getElementById('cardName').value = userData.displayName || currentUser.displayName || '';
            openModal(paymentModal);
        });

        closePaymentModal.addEventListener('click', () => closeModal(paymentModal));
        cancelPaymentModal.addEventListener('click', () => closeModal(paymentModal));

        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const paymentId = document.getElementById('paymentId').value;
            const cardNumber = document.getElementById('cardNumber').value;
            const cleanCardNumber = cardNumber.replace(/\s/g, '');
            const last4 = cleanCardNumber.slice(-4);
            const cardType = getCardType(cleanCardNumber);
            
            const paymentData = {
                cardNumber: cleanCardNumber,
                last4: last4,
                cardType: cardType,
                expiry: document.getElementById('cardExpiry').value,
                cardName: document.getElementById('cardName').value,
                isDefault: document.getElementById('setAsDefault').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (paymentId) {
                    // Update existing payment
                    await db.collection('users').doc(currentUser.uid).collection('payments').doc(paymentId).update(paymentData);
                    showToast('Payment method updated successfully!');
                } else {
                    // Add new payment
                    paymentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('users').doc(currentUser.uid).collection('payments').add(paymentData);
                    showToast('Payment method added successfully!');
                }
                
                // If this is set as default, update other payments
                if (paymentData.isDefault) {
                    await setDefaultPayment(paymentId || 'new');
                }
                
                await loadPaymentMethods();
                renderPaymentMethods();
                closeModal(paymentModal);
            } catch (error) {
                console.error('Error saving payment method:', error);
                showToast('Error saving payment method: ' + error.message, 'error');
            }
        });

        function editPayment(paymentId) {
            const payment = paymentMethods.find(pmt => pmt.id === paymentId);
            if (payment) {
                paymentModalTitle.textContent = 'Edit Payment Method';
                document.getElementById('paymentId').value = payment.id;
                document.getElementById('cardNumber').value = payment.cardNumber;
                document.getElementById('cardExpiry').value = payment.expiry;
                document.getElementById('cardCvv').value = ''; // Don't show CVV for security
                document.getElementById('cardName').value = payment.cardName;
                document.getElementById('setAsDefault').checked = payment.isDefault || false;
                openModal(paymentModal);
            }
        }

        async function deletePayment(paymentId) {
            if (confirm('Are you sure you want to delete this payment method?')) {
                try {
                    await db.collection('users').doc(currentUser.uid).collection('payments').doc(paymentId).delete();
                    await loadPaymentMethods();
                    renderPaymentMethods();
                    showToast('Payment method deleted successfully!');
                } catch (error) {
                    console.error('Error deleting payment method:', error);
                    showToast('Error deleting payment method: ' + error.message, 'error');
                }
            }
        }

        async function setDefaultPayment(paymentId) {
            try {
                // First, set all payments to not default
                const batch = db.batch();
                paymentMethods.forEach(payment => {
                    const paymentRef = db.collection('users').doc(currentUser.uid).collection('payments').doc(payment.id);
                    batch.update(paymentRef, { isDefault: false });
                });
                
                // Then set the selected one as default
                if (paymentId !== 'new') {
                    const defaultPaymentRef = db.collection('users').doc(currentUser.uid).collection('payments').doc(paymentId);
                    batch.update(defaultPaymentRef, { isDefault: true });
                }
                
                await batch.commit();
                await loadPaymentMethods();
                renderPaymentMethods();
                showToast('Default payment method updated!');
            } catch (error) {
                console.error('Error setting default payment:', error);
                showToast('Error setting default payment: ' + error.message, 'error');
            }
        }

        function getCardType(cardNumber) {
            const cardPatterns = {
                'Visa': /^4/,
                'Mastercard': /^5[1-5]/,
                'Amex': /^3[47]/,
                'Discover': /^6(?:011|5)/
            };
            
            for (const [cardType, pattern] of Object.entries(cardPatterns)) {
                if (pattern.test(cardNumber)) {
                    return cardType;
                }
            }
            return 'Visa';
        }

        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Error signing out:', error);
                    showToast('Error signing out', 'error');
                });
            }
        }

        logoutBtn.addEventListener('click', logout);
        mobileLogoutBtn.addEventListener('click', logout);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profile page loaded');
            
            // Check if user is authenticated
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'authpages.html';
                }
            });
        });
    </script>
</body>
</html>